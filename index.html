<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–ö–î Cost Calculator ‚Äî CC v2.0 (PDF —Ñ–∏–∫—Å)</title>

  <!-- PDF Export: html2canvas + jsPDF —á–µ—Ä–µ–∑ CDN (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤–µ—Ä—Å–∏–∏) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --line:#243055; --text:#e9eeff; --muted:#9aa7c7;
      --ok:#22c55e; --warn:#fbbf24; --bad:#ef4444; --accent:#60a5fa;
      --mono:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(120deg,#070a14,#0b1020 45%,#070a14);color:var(--text);font-family:var(--sans);}
    .wrap{max-width:1400px;margin:28px auto;padding:0 18px;}
    .report-header{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-end;margin:0 0 14px;}
    h1{font-size:20px;margin:0 0 6px;}
    .sub{margin:0 0 10px;color:var(--muted);font-size:13px;line-height:1.45;}
    .report-meta{color:var(--muted);font-size:12px;line-height:1.35;}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:11px;border:1px solid rgba(154,167,199,.25);color:var(--muted);background:rgba(11,18,41,.3);}

    .print-btn{
      cursor:pointer; border:1px solid rgba(96,165,250,.35);
      background:rgba(96,165,250,.15); color:var(--text);
      padding:8px 16px; border-radius:30px; font-size:13px;
      transition:background .1s;
    }
    .print-btn:hover{background:rgba(96,165,250,.25);}

    .grid{display:grid;grid-template-columns: 1.15fr 0.85fr;gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:rgba(18,26,51,.86);
      border:1px solid rgba(96,165,250,.16);
      border-radius:14px;
      padding:16px 16px 12px;
      box-shadow:0 10px 26px rgba(0,0,0,.25);
    }
    .card h2{font-size:14px;margin:0 0 10px;color:#cfe0ff;letter-spacing:.2px;}
    .row{display:grid;grid-template-columns:1.55fr 1fr;gap:10px;margin-bottom:8px;align-items:center;}
    label{font-size:12px;color:var(--muted);}
    input, select{
      width:100%; padding:10px 10px; border-radius:10px;
      border:1px solid rgba(154,167,199,.25); background:#0b1229; color:var(--text);
      outline:none; font-variant-numeric:tabular-nums;
    }
    input:focus, select:focus{border-color:rgba(96,165,250,.6);box-shadow:0 0 0 3px rgba(96,165,250,.14);}
    .small{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.35;}
    .hr{height:1px;background:linear-gradient(90deg,transparent,var(--line),transparent);margin:10px 0 12px;}

    /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ —Ç–∞–±–ª–∏—Ü */
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      table-layout:auto; /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —à–∏—Ä–∏–Ω–∞ */
    }
    th, td{
      padding:9px 8px;
      border-bottom:1px solid rgba(36,48,85,.7);
      vertical-align:middle;
    }
    th{color:#cfe0ff;text-align:left;font-weight:600;}
    td.num{text-align:right;font-family:var(--mono);font-variant-numeric:tabular-nums; white-space:nowrap;} /* —á–∏—Å–ª–∞ –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å */

    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px;}
    @media (max-width: 720px){ .kpi{grid-template-columns:1fr 1fr;} }
    @media (max-width: 520px){ .kpi{grid-template-columns:1fr;} }
    .k{
      background:rgba(11,18,41,.7);
      border:1px solid rgba(154,167,199,.14);
      border-radius:12px;
      padding:10px;
    }
    .k .t{font-size:11px;color:var(--muted);}
    .k .v{margin-top:6px;font-family:var(--mono);font-size:15px;font-variant-numeric:tabular-nums;}

    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    button{
      cursor:pointer; border:1px solid rgba(96,165,250,.35);
      background:rgba(96,165,250,.15); color:var(--text);
      padding:10px 12px; border-radius:12px; font-size:12px;
    }
    button:hover{background:rgba(96,165,250,.22);}
    button.secondary{border-color:rgba(154,167,199,.25);background:rgba(154,167,199,.10);}

    .input-wrap{position:relative;}
    .input-wrap input{padding-right:34px;}
    .input-wrap::after{
      content:"‚ÇΩ"; position:absolute; right:12px; top:50%; transform:translateY(-50%);
      color:var(--muted); font-size:12px; pointer-events:none;
    }

    .flags{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;}
    .pill{
      display:inline-flex;gap:6px;align-items:center;
      font-size:11px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(154,167,199,.25);color:var(--muted);
      background:rgba(11,18,41,.35);
    }
    .dot{width:8px;height:8px;border-radius:50%;}
    .dot.ok{background:var(--ok);}
    .dot.warn{background:var(--warn);}
    .dot.bad{background:var(--bad);}

    .margin-good{color:var(--ok);}
    .margin-mid{color:var(--warn);}
    .margin-bad{color:var(--bad);}

    .sens-wrap{margin-top:12px;}
    .sens-table{width:100%;border-collapse:collapse;font-size:12px;}
    .sens-table th, .sens-table td{border-bottom:1px solid rgba(36,48,85,.7);padding:7px 6px;}
    .sens-table th{color:#cfe0ff;text-align:center;font-weight:600;}
    .sens-table td{text-align:center;font-family:var(--mono);font-variant-numeric:tabular-nums;}

    .mini-note{margin-top:10px;color:var(--muted);font-size:11px;line-height:1.4;}

    /* ---------- –†–ï–ñ–ò–ú –≠–ö–°–ü–û–†–¢–ê (–±–µ–ª—ã–π —Ñ–æ–Ω, —á—ë—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã) ---------- */
    body.export-mode{
      background:#ffffff !important;
      color:#0b1020 !important;
    }
    body.export-mode .card{
      background:#ffffff !important;
      border:1px solid #a0b3d9 !important; /* –±–æ–ª–µ–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ */
      box-shadow:none !important;
    }
    body.export-mode .card h2,
    body.export-mode th{
      color:#0b1020 !important;
    }
    body.export-mode .sub,
    body.export-mode label,
    body.export-mode .small,
    body.export-mode .report-meta,
    body.export-mode .badge,
    body.export-mode .pill{
      color:#334155 !important;
    }
    body.export-mode input,
    body.export-mode select{
      background:#ffffff !important;
      color:#0b1020 !important;
      border:1px solid #a0b3d9 !important;
      box-shadow:none !important;
    }
    body.export-mode .input-wrap::after{
      color:#64748b !important;
    }
    /* –¢–∞–±–ª–∏—Ü—ã: –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ä–∞—Å–∫–ª–∞–¥–∫—É */
    body.export-mode table{
      border-collapse:collapse !important;
      width:100% !important;
      table-layout:fixed !important; /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞, —á—Ç–æ–±—ã –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ —Å–∂–∏–º–∞–ª–∏—Å—å */
    }
    body.export-mode th,
    body.export-mode td{
      border:1px solid #cbd5e1 !important; /* —è–≤–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã */
      padding:8px 6px !important;
      vertical-align:middle !important;
    }
    body.export-mode td.num{
      text-align:right !important;
      white-space:nowrap !important; /* –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å —á–∏—Å–ª–∞ */
      overflow:visible !important;
    }
    /* –∑–∞–¥–∞–¥–∏–º –ø—Ä–∏–º–µ—Ä–Ω—ã–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –∫–æ–ª–æ–Ω–æ–∫: –ø–µ—Ä–≤–∞—è 40%, –≤—Ç–æ—Ä–∞—è 30%, —Ç—Ä–µ—Ç—å—è 30% */
    body.export-mode th:first-child,
    body.export-mode td:first-child {
      width:40% !important;
    }
    body.export-mode th:nth-child(2),
    body.export-mode td:nth-child(2),
    body.export-mode th:nth-child(3),
    body.export-mode td:nth-child(3) {
      width:30% !important;
    }
    /* –¥–ª—è KPI –∫–∞—Ä—Ç–æ—á–µ–∫ –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç–æ–ª—å–∫–æ —Ñ–æ–Ω */
    body.export-mode .k{
      background:#f8fafc !important;
      border:1px solid #cbd5e1 !important;
    }
    /* —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ */
    body.export-mode button,
    body.export-mode .btns button,
    body.export-mode .print-btn,
    body.export-mode .btns{
      display:none !important;
    }

    /* ---------- –†–ï–ñ–ò–ú –ü–ï–ß–ê–¢–ò ---------- */
    @media print {
      body{background:#ffffff !important;color:#0b1020 !important;}
      .card{
        background:#ffffff !important;
        border:1px solid #a0b3d9 !important;
        box-shadow:none !important;
      }
      .card h2, th{color:#0b1020 !important;}
      .sub, label, .small, .report-meta, .badge, .pill{color:#334155 !important;}
      input, select{
        background:#ffffff !important;
        color:#0b1020 !important;
        border:1px solid #a0b3d9 !important;
        box-shadow:none !important;
      }
      .input-wrap::after{color:#64748b !important;}
      table{
        border-collapse:collapse !important;
        width:100% !important;
        table-layout:fixed !important;
      }
      th, td{
        border:1px solid #cbd5e1 !important;
        padding:8px 6px !important;
      }
      td.num{
        text-align:right !important;
        white-space:nowrap !important;
      }
      th:first-child, td:first-child { width:40% !important; }
      th:nth-child(2), td:nth-child(2),
      th:nth-child(3), td:nth-child(3) { width:30% !important; }
      .k{background:#f8fafc !important;border:1px solid #cbd5e1 !important;}
      button, .print-btn, .btns button, .btns{display:none !important;}
    }
  </style>
</head>

<body>
  <div class="wrap" id="reportRoot">
    <div class="report-header">
      <div>
        <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ú–ö–î (SPV + –≤–∑–∞–∏–º–æ–∑–∞–≤–∏—Å–∏–º—ã–π –ì–ü) ‚Äî CC v2.0</h1>
        <div class="sub">–°–ú–† ‚Üí CAPEX ‚Üí –ø—Ä–∏–±—ã–ª—å/–º–∞—Ä–∂–∞ + —Å—Ç—Ä–µ—Å—Å/—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å + –±–∞–Ω–∫–æ–≤—Å–∫–∏–π –±–ª–æ–∫ (DSCR/LTC/LTV) –∏ —ç–∫—Å–ø–æ—Ä—Ç PDF.</div>
      </div>
      <div style="display:flex; gap:12px; align-items:center;">
        <button class="print-btn" id="btnPrint">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å</button>
        <div class="report-meta">
          <div><span class="badge">–û—Ç—á–µ—Ç –¥–ª—è –∫—Ä–µ–¥–∏—Ç–Ω–æ–≥–æ –∫–æ–º–∏—Ç–µ—Ç–∞</span></div>
          <div>–î–∞—Ç–∞/–≤—Ä–µ–º—è: <span id="generatedAt">‚Äî</span></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: INPUTS (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã) -->
      <div class="card">
        <h2>1) –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
        <div class="row"><label for="gba">GBA (–º¬≤)</label><input id="gba" type="text" value="20000" inputmode="numeric" /></div>
        <div class="row"><label for="nsa">NSA (–º¬≤)</label><input id="nsa" type="text" value="14000" inputmode="numeric" /></div>
        <div class="row"><label for="price">–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ (‚ÇΩ/–º¬≤ NSA)</label><div class="input-wrap"><input id="price" type="text" value="140000" inputmode="numeric" /></div></div>
        <div class="hr"></div>
        <h2>2) –°–ú–† (—Ä—É–±/–º¬≤ GBA)</h2>
        <div class="row"><label for="c1">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤</label><div class="input-wrap"><input id="c1" type="text" value="22000" inputmode="numeric" /></div></div>
        <div class="row"><label for="c2">–§–∞—Å–∞–¥</label><div class="input-wrap"><input id="c2" type="text" value="7000" inputmode="numeric" /></div></div>
        <div class="row"><label for="c3">–ò–Ω–∂–µ–Ω–µ—Ä–∏—è</label><div class="input-wrap"><input id="c3" type="text" value="12000" inputmode="numeric" /></div></div>
        <div class="row"><label for="c4">–û—Ç–¥–µ–ª–∫–∞</label><div class="input-wrap"><input id="c4" type="text" value="8000" inputmode="numeric" /></div></div>
        <div class="row"><label for="c5">–ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</label><div class="input-wrap"><input id="c5" type="text" value="3500" inputmode="numeric" /></div></div>
        <div class="row"><label for="c6">–ü—Ä–æ—á–∏–µ</label><div class="input-wrap"><input id="c6" type="text" value="2500" inputmode="numeric" /></div></div>
        <div class="row"><label for="lift">–õ–∏—Ñ—Ç—ã (—Ñ–∏–∫—Å)</label><div class="input-wrap"><input id="lift" type="text" value="50000000" inputmode="numeric" /></div></div>
        <div class="hr"></div>
        <h2>3) –ù–∞–∫–ª–∞–¥–Ω—ã–µ / –ø—Ä–∏–±—ã–ª—å –ì–ü / —Ä–µ–∑–µ—Ä–≤</h2>
        <div class="row"><label for="overhead">–ù–∞–∫–ª–∞–¥–Ω—ã–µ, % –æ—Ç –ø—Ä—è–º—ã—Ö</label><input id="overhead" type="text" value="10" inputmode="decimal" /></div>
        <div class="row"><label for="gp">–ü—Ä–∏–±—ã–ª—å –ì–ü, % –æ—Ç (–ø—Ä—è–º—ã–µ+–Ω–∞–∫–ª–∞–¥–Ω—ã–µ)</label><input id="gp" type="text" value="5" inputmode="decimal" /></div>
        <div class="row"><label for="reserve">–†–µ–∑–µ—Ä–≤/—Ä–∏—Å–∫–∏, % –æ—Ç –°–ú–†</label><input id="reserve" type="text" value="2" inputmode="decimal" /></div>
        <div class="hr"></div>
        <h2>4) –ü—Ä–æ—á–∏–µ CAPEX (–Ω–µ –°–ú–†)</h2>
        <div class="row"><label for="land">–ó–µ–º–ª—è</label><div class="input-wrap"><input id="land" type="text" value="200000000" inputmode="numeric" /></div></div>
        <div class="row"><label for="tu">–¢–£ / —Å–µ—Ç–∏</label><div class="input-wrap"><input id="tu" type="text" value="120000000" inputmode="numeric" /></div></div>
        <div class="row"><label for="design">–ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</label><div class="input-wrap"><input id="design" type="text" value="35000000" inputmode="numeric" /></div></div>
        <div class="row"><label for="bank_fee">–ö–æ–º–∏—Å—Å–∏–∏ –±–∞–Ω–∫–∞ (—Ä–∞–∑–æ–≤–æ)</label><div class="input-wrap"><input id="bank_fee" type="text" value="20000000" inputmode="numeric" /></div></div>
        <div class="small">–ü—Ä–æ—Ü–µ–Ω—Ç—ã –ø–æ –∫—Ä–µ–¥–∏—Ç—É —Å—á–∏—Ç–∞—é—Ç—Å—è –Ω–∏–∂–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) –∏ –≤—Ö–æ–¥—è—Ç –≤ –∏—Ç–æ–≥–æ–≤—ã–π CAPEX/–¥–æ–ª–≥.</div>
        <div class="hr"></div>
        <h2>5) –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</h2>
        <div class="row"><label for="commercial">–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã, % –æ—Ç –≤—ã—Ä—É—á–∫–∏</label><input id="commercial" type="text" value="3" inputmode="decimal" /></div>
        <div class="hr"></div>
        <h2>6) –°—Ç—Ä–µ—Å—Å-–º–æ–¥–µ–ª—å</h2>
        <div class="row"><label for="stress_price">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã, %</label><input id="stress_price" type="text" value="-10" inputmode="decimal" /></div>
        <div class="row"><label for="stress_smr">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –°–ú–†, %</label><input id="stress_smr" type="text" value="15" inputmode="decimal" /></div>
        <div class="hr"></div>
        <h2>7) –ë–∞–Ω–∫ / –ø—Ä–æ–µ–∫—Ç–Ω–æ–µ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ / —ç—Å–∫—Ä–æ—É</h2>
        <div class="row"><label for="equity">–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ (Equity), ‚ÇΩ</label><div class="input-wrap"><input id="equity" type="text" value="300000000" inputmode="numeric" /></div></div>
        <div class="row"><label for="loan_limit">–õ–∏–º–∏—Ç –∫—Ä–µ–¥–∏—Ç–∞ (Debt limit), ‚ÇΩ</label><div class="input-wrap"><input id="loan_limit" type="text" value="2000000000" inputmode="numeric" /></div></div>
        <div class="row"><label for="rate">–°—Ç–∞–≤–∫–∞ –∫—Ä–µ–¥–∏—Ç–∞, % –≥–æ–¥–æ–≤—ã—Ö</label><input id="rate" type="text" value="18" inputmode="decimal" /></div>
        <div class="row"><label for="constr_months">–°—Ä–æ–∫ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞, –º–µ—Å</label><input id="constr_months" type="text" value="24" inputmode="numeric" /></div>
        <div class="row"><label for="tail_months">–°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞, –º–µ—Å</label><input id="tail_months" type="text" value="6" inputmode="numeric" /></div>
        <div class="row"><label for="pre_sale_share">–î–æ–ª—è –ø—Ä–æ–¥–∞–∂ –¥–æ –≤–≤–æ–¥–∞, % (—ç—Å–∫—Ä–æ—É)</label><input id="pre_sale_share" type="text" value="80" inputmode="decimal" /></div>
        <div class="row"><label for="escrow_release_months">–†–µ–ª–∏–∑ —ç—Å–∫—Ä–æ—É –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞, –º–µ—Å</label><input id="escrow_release_months" type="text" value="3" inputmode="numeric" /></div>
        <div class="row"><label for="capex_soft_months">‚Äú–ú—è–≥–∫–∏–µ‚Äù –∑–∞—Ç—Ä–∞—Ç—ã (–¢–£/–ø—Ä–æ–µ–∫—Ç), –º–µ—Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è</label><input id="capex_soft_months" type="text" value="6" inputmode="numeric" /></div>
        <div class="hr"></div>
        <h2>8) –ö–æ–≤–µ–Ω–∞–Ω—Ç—ã (–¥–ª—è —Ñ–ª–∞–≥–æ–≤)</h2>
        <div class="row"><label for="cov_dscr">Min DSCR (x)</label><input id="cov_dscr" type="text" value="1.20" inputmode="decimal" /></div>
        <div class="row"><label for="cov_ltc">Max LTC (%)</label><input id="cov_ltc" type="text" value="80" inputmode="decimal" /></div>
        <div class="row"><label for="cov_ltv">Max LTV (%)</label><input id="cov_ltv" type="text" value="70" inputmode="decimal" /></div>

        <div class="btns">
          <button id="btnPdf">–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF (A4) ‚Äî –∫—Ä–µ–¥–∏—Ç–Ω—ã–π –∫–æ–º–∏—Ç–µ—Ç</button>
          <button class="secondary" id="btnDemo">–î–µ–º–æ-–Ω–∞–±–æ—Ä</button>
          <button class="secondary" id="btnReset">–°–±—Ä–æ—Å</button>
        </div>
        <div class="mini-note">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –±–ª–æ–∫ ‚Äî —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π...</div>
      </div>

      <!-- RIGHT: RESULTS -->
      <div class="card">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã (—ç–∫–æ–Ω–æ–º–∏–∫–∞)</h2>
        <table>
          <thead><tr><th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th><th class="num">–ë–∞–∑–∞</th><th class="num">–°—Ç—Ä–µ—Å—Å</th></tr></thead>
          <tbody>
            <tr><td>–í—ã—Ä—É—á–∫–∞</td><td class="num" id="rev">‚Äî</td><td class="num" id="rev_s">‚Äî</td></tr>
            <tr><td>–ò—Ç–æ–≥–æ –°–ú–†</td><td class="num" id="smr">‚Äî</td><td class="num" id="smr_s">‚Äî</td></tr>
            <tr><td>–ò—Ç–æ–≥–æ CAPEX (–±–µ–∑ % –∫—Ä–µ–¥–∏—Ç–∞)</td><td class="num" id="capex_no_int">‚Äî</td><td class="num" id="capex_no_int_s">‚Äî</td></tr>
            <tr><td>–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</td><td class="num" id="comm">‚Äî</td><td class="num" id="comm_s">‚Äî</td></tr>
            <tr><td><b>–ü—Ä–æ—Ñ–∏—Ç –¥–µ–≤–µ–ª–æ–ø–µ—Ä–∞ (–ø–æ—Å–ª–µ % –∫—Ä–µ–¥–∏—Ç–∞)</b></td><td class="num" id="profit"><b>‚Äî</b></td><td class="num" id="profit_s"><b>‚Äî</b></td></tr>
          </tbody>
        </table>
        <div class="kpi">
          <div class="k"><div class="t">–°–ú–† ‚ÇΩ/–º¬≤ GBA</div><div class="v" id="smr_m2">‚Äî</div></div>
          <div class="k"><div class="t">CAPEX ‚ÇΩ/–º¬≤ NSA</div><div class="v" id="capex_m2">‚Äî</div></div>
          <div class="k"><div class="t">–ú–∞—Ä–∂–∞ –¥–µ–≤–µ–ª–æ–ø–µ—Ä–∞</div><div class="v" id="margin_pct">‚Äî</div></div>
          <div class="k"><div class="t">–ó–∞–ø–∞—Å –∫ —Ü–µ–Ω–µ (‚ÇΩ/–º¬≤ NSA)</div><div class="v" id="buffer">‚Äî</div></div>
        </div>
        <div class="flags" id="flagsEco"></div>
        <div class="hr"></div>
        <h2>–ë–∞–Ω–∫-KPI (DSCR / LTC / LTV)</h2>
        <table>
          <tbody>
            <tr><th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th><th class="num">–ë–∞–∑–∞</th><th class="num">–°—Ç—Ä–µ—Å—Å</th></tr>
            <tr><td>Max Debt (–ø–∏–∫ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏)</td><td class="num" id="b_maxdebt">‚Äî</td><td class="num" id="b_maxdebt_s">‚Äî</td></tr>
            <tr><td>–ü—Ä–æ—Ü–µ–Ω—Ç—ã –ø–æ –∫—Ä–µ–¥–∏—Ç—É (–∫–∞–ø–∏—Ç–∞–ª–∏–∑.)</td><td class="num" id="b_int">‚Äî</td><td class="num" id="b_int_s">‚Äî</td></tr>
            <tr><td>LTC = Max Debt / Total Cost</td><td class="num" id="b_ltc">‚Äî</td><td class="num" id="b_ltc_s">‚Äî</td></tr>
            <tr><td>LTV = Max Debt / Revenue</td><td class="num" id="b_ltv">‚Äî</td><td class="num" id="b_ltv_s">‚Äî</td></tr>
            <tr><td>Min DSCR (–ø–æ –º–µ—Å—è—Ü–∞–º —Ä–µ–ª–∏–∑–∞)</td><td class="num" id="b_dscr_min">‚Äî</td><td class="num" id="b_dscr_min_s">‚Äî</td></tr>
            <tr><td>Avg DSCR (–ø–æ –º–µ—Å—è—Ü–∞–º —Ä–µ–ª–∏–∑–∞)</td><td class="num" id="b_dscr_avg">‚Äî</td><td class="num" id="b_dscr_avg_s">‚Äî</td></tr>
          </tbody>
        </table>
        <div class="flags" id="flagsBank"></div>
        <div class="hr"></div>
        <h2>–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 5√ó5 (–º–∞—Ä–∂–∞ –¥–µ–≤–µ–ª–æ–ø–µ—Ä–∞, %)</h2>
        <div class="small">–°—Ç—Ä–æ–∫–∏: –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã. –°—Ç–æ–ª–±—Ü—ã: –∏–∑–º–µ–Ω–µ–Ω–∏–µ –°–ú–†. –¶–≤–µ—Ç ‚Äî —É—Ä–æ–≤–µ–Ω—å —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏.</div>
        <div class="sens-wrap" id="sensitivity">‚Äî</div>
      </div>
    </div>
  </div>

  <script>
    // ---------- utils ----------
    const $ = (id) => document.getElementById(id);
    function parseNumber(v){
      const s = String(v ?? "").replace(/[‚ÇΩ\u00A0\s]/g, "").replace(",", ".");
      const x = Number(s);
      return Number.isFinite(x) ? x : 0;
    }
    function fmtInt(x){ return Math.round(x).toLocaleString("ru-RU"); }
    function rub(x){ return fmtInt(x) + " ‚ÇΩ"; }
    function rubm2(x){ return fmtInt(x) + " ‚ÇΩ/–º¬≤"; }
    function percent(x){
      return (x*100).toLocaleString("ru-RU",{minimumFractionDigits:1, maximumFractionDigits:1}) + " %";
    }
    function xNum(x){
      return (x).toLocaleString("ru-RU",{minimumFractionDigits:2, maximumFractionDigits:2}) + "x";
    }
    function get(id){ return parseNumber($(id).value); }
    function setGeneratedAt(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      $("generatedAt").textContent = `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function marginClass(m){
      if (m >= 0.18) return "margin-good";
      if (m >= 0.10) return "margin-mid";
      return "margin-bad";
    }
    function pill(type, text){
      const div = document.createElement("div");
      div.className = "pill";
      const dot = document.createElement("span");
      dot.className = "dot " + type;
      const t = document.createElement("span");
      t.textContent = text;
      div.appendChild(dot); div.appendChild(t);
      return div;
    }

    // ---------- core economics ----------
    function econScenario(priceMul, smrMul){
      const gba = get("gba"), nsa = get("nsa"), price = get("price") * priceMul;
      const directPerM2 = get("c1")+get("c2")+get("c3")+get("c4")+get("c5")+get("c6");
      const direct = (gba * directPerM2 + get("lift")) * smrMul;
      const overhead = direct * (get("overhead")/100);
      const gpProfit = (direct + overhead) * (get("gp")/100);
      const reserve = (direct + overhead + gpProfit) * (get("reserve")/100);
      const smr = direct + overhead + gpProfit + reserve;
      const capexNoInt = smr + get("land") + get("tu") + get("design") + get("bank_fee");
      const revenue = nsa * price;
      const commercial = revenue * (get("commercial")/100);
      return { gba, nsa, price, revenue, direct, overhead, gpProfit, reserve, smr, capexNoInt, commercial };
    }

    // ---------- bank simulation ----------
    function bankScenario(priceMul, smrMul){
      const econ = econScenario(priceMul, smrMul);
      const constr = Math.max(1, Math.round(get("constr_months")));
      const tail = Math.max(0, Math.round(get("tail_months")));
      const rel = Math.max(1, Math.round(get("escrow_release_months")));
      const softM = Math.max(1, Math.round(get("capex_soft_months")));
      const equity = get("equity");
      const loanLimit = get("loan_limit");
      const rate = get("rate")/100;
      const rMonthly = rate / 12;
      const preShare = Math.min(100, Math.max(0, get("pre_sale_share"))) / 100;
      const totalRevenue = econ.revenue;
      const preRevenue = totalRevenue * preShare;
      const tailRevenue = totalRevenue - preRevenue;
      const preSalesMonthly = preRevenue / constr;
      const tailSalesMonthly = tail > 0 ? (tailRevenue / tail) : 0;
      let cash = equity, debt = 0, maxDebt = 0, capIntTotal = 0;
      let dscrMin = Infinity, dscrSum = 0, dscrCnt = 0;
      const commPct = get("commercial")/100;
      const smrMonthly = econ.smr / constr;
      const landPay = get("land"), bankFeePay = get("bank_fee"), tuPay = get("tu"), designPay = get("design");
      const softMonthly = (tuPay + designPay) / softM;
      const totalMonths = constr + tail + rel;
      for (let m=1; m<=totalMonths; m++){
        const inConstruction = m <= constr;
        const inTail = (m > constr) && (m <= constr + tail);
        const inRelease = (m > constr) && (m <= constr + rel);
        let sales = 0;
        if (inConstruction) sales = preSalesMonthly;
        else if (inTail) sales = tailSalesMonthly;
        const commOut = sales * commPct;
        let capexOut = 0;
        if (inConstruction) capexOut += smrMonthly;
        if (m === 1) capexOut += landPay + bankFeePay;
        if (m <= softM) capexOut += softMonthly;
        let escrowRelease = 0;
        if (inRelease) escrowRelease = preRevenue / rel;
        const tailCashIn = (!inConstruction && inTail) ? sales : 0;
        const interestAccrued = debt * rMonthly;
        let interestPaid = 0, principalPaid = 0;
        cash += escrowRelease + tailCashIn;
        cash -= (capexOut + commOut);
        if (inConstruction){
          debt += interestAccrued;
          capIntTotal += interestAccrued;
        } else {
          if (cash >= interestAccrued){
            cash -= interestAccrued;
            interestPaid = interestAccrued;
          } else {
            interestPaid = Math.max(0, cash);
            const short = interestAccrued - interestPaid;
            cash = 0;
            debt += short;
            capIntTotal += short;
          }
        }
        if (cash < 0){
          const need = -cash;
          const draw = Math.min(need, Math.max(0, loanLimit - debt));
          debt += draw;
          cash += draw;
          if (cash < 0) cash = 0;
        }
        if (inRelease){
          if (cash > 0 && debt > 0){
            principalPaid = Math.min(cash, debt);
            debt -= principalPaid;
            cash -= principalPaid;
          }
          const cfads = escrowRelease + tailCashIn - capexOut - commOut;
          const debtService = interestPaid + principalPaid;
          if (debtService > 0){
            const dscr = cfads / debtService;
            dscrMin = Math.min(dscrMin, dscr);
            dscrSum += dscr;
            dscrCnt += 1;
          }
        }
        maxDebt = Math.max(maxDebt, debt);
      }
      if (dscrMin === Infinity) dscrMin = 0;
      const dscrAvg = dscrCnt > 0 ? (dscrSum / dscrCnt) : 0;
      const totalCost = econ.capexNoInt + econ.commercial + capIntTotal;
      const ltc = totalCost > 0 ? (maxDebt / totalCost) : 0;
      const ltv = econ.revenue > 0 ? (maxDebt / econ.revenue) : 0;
      const devProfit = econ.revenue - (econ.capexNoInt + econ.commercial + capIntTotal);
      const devMargin = econ.revenue !== 0 ? devProfit / econ.revenue : 0;
      return { econ, capIntTotal, maxDebt, ltc, ltv, dscrMin, dscrAvg, devProfit, devMargin };
    }

    // ---------- renderSensitivity ----------
    function renderSensitivity(){
      const smrRange = [-0.10,-0.05,0,0.05,0.10];
      const priceRange = [-0.10,-0.05,0,0.05,0.10];
      let html = `<table class="sens-table"><thead><tr><th>–¶–µ–Ω–∞ \\ –°–ú–†</th>`;
      for (const s of smrRange) html += `<th>${(s*100).toLocaleString("ru-RU")}%</th>`;
      html += `</tr></thead><tbody>`;
      for (const p of priceRange){
        html += `<tr><th>${(p*100).toLocaleString("ru-RU")}%</th>`;
        for (const s of smrRange){
          const b = bankScenario(1+p, 1+s);
          const cls = marginClass(b.devMargin);
          html += `<td class="${cls}">${percent(b.devMargin)}</td>`;
        }
        html += `</tr>`;
      }
      html += `</tbody></table>`;
      $("sensitivity").innerHTML = html;
    }

    function renderEcoFlags(baseBank, stressBank){
      const el = $("flagsEco"); el.innerHTML = "";
      el.appendChild(pill(baseBank.devProfit >= 0 ? "ok":"bad", baseBank.devProfit >= 0 ? "–ë–∞–∑–∞: –ø—Ä–∏–±—ã–ª—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è" : "–ë–∞–∑–∞: –ø—Ä–∏–±—ã–ª—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è"));
      const m = baseBank.devMargin;
      if (m >= 0.18) el.appendChild(pill("ok", `–ú–∞—Ä–∂–∞ –±–∞–∑—ã ${percent(m)} ‚Äî –≤—ã—Å–æ–∫–∏–π –∑–∞–ø–∞—Å`));
      else if (m >= 0.10) el.appendChild(pill("warn", `–ú–∞—Ä–∂–∞ –±–∞–∑—ã ${percent(m)} ‚Äî —Å—Ä–µ–¥–Ω–∏–π –∑–∞–ø–∞—Å`));
      else el.appendChild(pill("bad", `–ú–∞—Ä–∂–∞ –±–∞–∑—ã ${percent(m)} ‚Äî –Ω–∏–∑–∫–∏–π –∑–∞–ø–∞—Å`));
      const ms = stressBank.devMargin;
      el.appendChild(pill(stressBank.devProfit >= 0 ? "ok":"bad", stressBank.devProfit >= 0 ? "–°—Ç—Ä–µ—Å—Å: –ø—Ä–∏–±—ã–ª—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è" : "–°—Ç—Ä–µ—Å—Å: –ø—Ä–∏–±—ã–ª—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è"));
      if (ms < 0.10) el.appendChild(pill("bad", `–°—Ç—Ä–µ—Å—Å-–º–∞—Ä–∂–∞ ${percent(ms)} ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ`));
      const gba = get("gba"), nsa = get("nsa");
      if (gba <= 0 || nsa <= 0) el.appendChild(pill("bad", "–ü–ª–æ—â–∞–¥–∏: GBA/NSA –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å > 0"));
      if (nsa > gba) el.appendChild(pill("warn", "NSA > GBA ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–æ–¥"));
    }

    function renderBankFlags(baseBank, stressBank){
      const el = $("flagsBank"); el.innerHTML = "";
      const covD = get("cov_dscr"), covLTC = get("cov_ltc")/100, covLTV = get("cov_ltv")/100;
      el.appendChild(pill(baseBank.dscrMin >= covD ? "ok" : "bad", `DSCR min (–±–∞–∑–∞): ${xNum(baseBank.dscrMin)} vs cov ${xNum(covD)}`));
      el.appendChild(pill(baseBank.ltc <= covLTC ? "ok" : "bad", `LTC (–±–∞–∑–∞): ${percent(baseBank.ltc)} vs cov ${percent(covLTC)}`));
      el.appendChild(pill(baseBank.ltv <= covLTV ? "ok" : "bad", `LTV (–±–∞–∑–∞): ${percent(baseBank.ltv)} vs cov ${percent(covLTV)}`));
      el.appendChild(pill(stressBank.dscrMin >= covD ? "ok" : "bad", `DSCR min (—Å—Ç—Ä–µ—Å—Å): ${xNum(stressBank.dscrMin)}`));
      el.appendChild(pill(stressBank.ltc <= covLTC ? "ok" : "bad", `LTC (—Å—Ç—Ä–µ—Å—Å): ${percent(stressBank.ltc)}`));
      el.appendChild(pill(stressBank.ltv <= covLTV ? "ok" : "bad", `LTV (—Å—Ç—Ä–µ—Å—Å): ${percent(stressBank.ltv)}`));
      const loanLimit = get("loan_limit");
      if (baseBank.maxDebt > loanLimit) el.appendChild(pill("bad", "–ü–∏–∫ –¥–æ–ª–≥–∞ (–±–∞–∑–∞) –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –∫—Ä–µ–¥–∏—Ç–∞"));
      else el.appendChild(pill("ok", "–ü–∏–∫ –¥–æ–ª–≥–∞ (–±–∞–∑–∞) –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞"));
      if (stressBank.maxDebt > loanLimit) el.appendChild(pill("bad", "–ü–∏–∫ –¥–æ–ª–≥–∞ (—Å—Ç—Ä–µ—Å—Å) –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –∫—Ä–µ–¥–∏—Ç–∞"));
      else el.appendChild(pill("ok", "–ü–∏–∫ –¥–æ–ª–≥–∞ (—Å—Ç—Ä–µ—Å—Å) –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞"));
    }

    function calcAndRender(){
      setGeneratedAt();
      const base = bankScenario(1,1);
      const stress = bankScenario(1 + get("stress_price")/100, 1 + get("stress_smr")/100);
      $("rev").textContent = rub(base.econ.revenue);
      $("rev_s").textContent = rub(stress.econ.revenue);
      $("smr").textContent = rub(base.econ.smr);
      $("smr_s").textContent = rub(stress.econ.smr);
      $("capex_no_int").textContent = rub(base.econ.capexNoInt);
      $("capex_no_int_s").textContent = rub(stress.econ.capexNoInt);
      $("comm").textContent = rub(base.econ.commercial);
      $("comm_s").textContent = rub(stress.econ.commercial);
      $("profit").textContent = rub(base.devProfit);
      $("profit_s").textContent = rub(stress.devProfit);
      $("profit").className = "num " + marginClass(base.devMargin);
      $("profit_s").className = "num " + marginClass(stress.devMargin);
      $("smr_m2").textContent = base.econ.gba ? rubm2(base.econ.smr / base.econ.gba) : "‚Äî";
      const totalCostBase = base.econ.capexNoInt + base.econ.commercial + base.capIntTotal;
      $("capex_m2").textContent = base.econ.nsa ? rubm2(totalCostBase / base.econ.nsa) : "‚Äî";
      $("margin_pct").textContent = percent(base.devMargin);
      $("margin_pct").className = "v " + marginClass(base.devMargin);
      $("buffer").textContent = base.econ.nsa ? rubm2(base.econ.price - (totalCostBase / base.econ.nsa)) : "‚Äî";
      $("b_maxdebt").textContent = rub(base.maxDebt);
      $("b_maxdebt_s").textContent = rub(stress.maxDebt);
      $("b_int").textContent = rub(base.capIntTotal);
      $("b_int_s").textContent = rub(stress.capIntTotal);
      $("b_ltc").textContent = percent(base.ltc);
      $("b_ltc_s").textContent = percent(stress.ltc);
      $("b_ltv").textContent = percent(base.ltv);
      $("b_ltv_s").textContent = percent(stress.ltv);
      $("b_dscr_min").textContent = xNum(base.dscrMin);
      $("b_dscr_min_s").textContent = xNum(stress.dscrMin);
      $("b_dscr_avg").textContent = xNum(base.dscrAvg);
      $("b_dscr_avg_s").textContent = xNum(stress.dscrAvg);
      renderEcoFlags(base, stress);
      renderBankFlags(base, stress);
      renderSensitivity();
    }

    // ---------- localStorage ----------
    const STORAGE_KEY = "mkdCalculatorData";
    function saveState(){
      const ids = ["gba","nsa","price","c1","c2","c3","c4","c5","c6","lift","overhead","gp","reserve","land","tu","design","bank_fee","commercial","stress_price","stress_smr","equity","loan_limit","rate","constr_months","tail_months","pre_sale_share","escrow_release_months","capex_soft_months","cov_dscr","cov_ltc","cov_ltv"];
      const data = {};
      ids.forEach(id => { data[id] = $(id).value; });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try {
        const data = JSON.parse(raw);
        Object.keys(data).forEach(id => { const el = $(id); if (el) el.value = data[id]; });
        return true;
      } catch (e) { return false; }
    }

    // ---------- input masking ----------
    const PERCENT_IDS = new Set(["overhead","gp","reserve","commercial","stress_price","stress_smr","rate","pre_sale_share","cov_ltc","cov_ltv"]);
    const DECIMAL_IDS = new Set(["cov_dscr"]);
    function attachInputMask(id){
      const el = $(id);
      el.addEventListener("focus", () => { el.value = String(parseNumber(el.value)); });
      el.addEventListener("blur", () => {
        const v = parseNumber(el.value);
        if (PERCENT_IDS.has(id) || DECIMAL_IDS.has(id)){
          el.value = v.toLocaleString("ru-RU",{maximumFractionDigits:2});
        } else {
          el.value = fmtInt(v);
        }
        calcAndRender();
        saveState();
      });
      el.addEventListener("input", () => calcAndRender());
      const init = parseNumber(el.value);
      if (PERCENT_IDS.has(id) || DECIMAL_IDS.has(id)){
        el.value = init.toLocaleString("ru-RU",{maximumFractionDigits:2});
      } else {
        el.value = fmtInt(init);
      }
    }

    // ---------- PDF export (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π) ----------
    async function exportPdf(){
      if (typeof html2canvas === "undefined" || typeof window.jspdf === "undefined"){
        alert("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è PDF –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
        return;
      }
      
      document.body.classList.add("export-mode");
      // –£–≤–µ–ª–∏—á–∏–º —Ç–∞–π–º–∞—É—Ç, —á—Ç–æ–±—ã —Å—Ç–∏–ª–∏ —Ç–æ—á–Ω–æ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å
      await new Promise(r => setTimeout(r, 800));

      const root = document.getElementById("reportRoot");
      if (!root) {
        alert("–≠–ª–µ–º–µ–Ω—Ç –æ—Ç—á—ë—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω");
        document.body.classList.remove("export-mode");
        return;
      }

      try {
        console.log("–ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ PDF...");
        const canvas = await html2canvas(root, { 
          scale: 2, 
          useCORS: true, 
          backgroundColor: "#ffffff",
          logging: false,
          allowTaint: false,
          windowWidth: 1400,       // —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–∂–∞—Ç–∏—è
        });
        
        console.log("Canvas —Å–æ–∑–¥–∞–Ω, —Ä–∞–∑–º–µ—Ä:", canvas.width, "x", canvas.height);
        
        if (canvas.width === 0 || canvas.height === 0) {
          throw new Error("Canvas –∏–º–µ–µ—Ç –Ω—É–ª–µ–≤–æ–π —Ä–∞–∑–º–µ—Ä. –í–æ–∑–º–æ–∂–Ω–æ, —ç–ª–µ–º–µ–Ω—Ç —Å–∫—Ä—ã—Ç –∏–ª–∏ –Ω–µ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω.");
        }

        const imgData = canvas.toDataURL("image/png");
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });

        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = pageWidth;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        if (imgHeight <= pageHeight){
          pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
        } else {
          let y = 0;
          let remaining = imgHeight;
          while (remaining > 0){
            pdf.addImage(imgData, "PNG", 0, -y, imgWidth, imgHeight);
            remaining -= pageHeight;
            y += pageHeight;
            if (remaining > 0) pdf.addPage();
          }
        }

        const now = new Date();
        const pad = (n)=>String(n).padStart(2,"0");
        const fname = `MKD_CC_${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.pdf`;
        pdf.save(fname);
        console.log("PDF —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω");
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF:", error);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å PDF. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏.\n" + error.message);
      } finally {
        document.body.classList.remove("export-mode");
      }
    }

    // ---------- init ----------
    function init(){
      loadState();
      const ids = ["gba","nsa","price","c1","c2","c3","c4","c5","c6","lift","overhead","gp","reserve","land","tu","design","bank_fee","commercial","stress_price","stress_smr","equity","loan_limit","rate","constr_months","tail_months","pre_sale_share","escrow_release_months","capex_soft_months","cov_dscr","cov_ltc","cov_ltv"];
      ids.forEach(attachInputMask);

      $("btnPdf").addEventListener("click", exportPdf);
      $("btnPrint").addEventListener("click", () => window.print());
      $("btnReset").addEventListener("click", () => {
        localStorage.removeItem(STORAGE_KEY);
        window.location.reload();
      });
      $("btnDemo").addEventListener("click", () => {
        $("gba").value = "24 000"; $("nsa").value = "16 800"; $("price").value = "145 000";
        $("c1").value = "22 500"; $("c2").value = "7 000"; $("c3").value = "12 500";
        $("c4").value = "8 500"; $("c5").value = "3 800"; $("c6").value = "2 600";
        $("lift").value = "52 000 000"; $("overhead").value = "10"; $("gp").value = "5";
        $("reserve").value = "2"; $("land").value = "220 000 000"; $("tu").value = "140 000 000";
        $("design").value = "40 000 000"; $("bank_fee").value = "25 000 000"; $("commercial").value = "3";
        $("stress_price").value = "-10"; $("stress_smr").value = "15"; $("equity").value = "350 000 000";
        $("loan_limit").value = "2 100 000 000"; $("rate").value = "18"; $("constr_months").value = "24";
        $("tail_months").value = "6"; $("pre_sale_share").value = "80"; $("escrow_release_months").value = "3";
        $("capex_soft_months").value = "6"; $("cov_dscr").value = "1.20"; $("cov_ltc").value = "80";
        $("cov_ltv").value = "70";

        ids.forEach(id => {
          const el = $(id);
          const v = parseNumber(el.value);
          if (PERCENT_IDS.has(id) || DECIMAL_IDS.has(id)){
            el.value = v.toLocaleString("ru-RU",{maximumFractionDigits:2});
          } else {
            el.value = fmtInt(v);
          }
        });
        calcAndRender();
        saveState();
      });

      calcAndRender();
      saveState();
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
