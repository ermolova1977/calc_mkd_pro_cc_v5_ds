<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–ö–î Cost Calculator ‚Äî CC v2.0 (—Å –ø–∞–º—è—Ç—å—é + PDF)</title>

  <!-- PDF Export: html2canvas + jsPDF —á–µ—Ä–µ–∑ CDN (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --line:#243055; --text:#e9eeff; --muted:#9aa7c7;
      --ok:#22c55e; --warn:#fbbf24; --bad:#ef4444; --accent:#60a5fa;
      --mono:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(120deg,#070a14,#0b1020 45%,#070a14);color:var(--text);font-family:var(--sans);}
    .wrap{max-width:1400px;margin:28px auto;padding:0 18px;}
    .report-header{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-end;margin:0 0 14px;}
    h1{font-size:20px;margin:0 0 6px;}
    .sub{margin:0 0 10px;color:var(--muted);font-size:13px;line-height:1.45;}
    .report-meta{color:var(--muted);font-size:12px;line-height:1.35;}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:11px;border:1px solid rgba(154,167,199,.25);color:var(--muted);background:rgba(11,18,41,.3);}

    /* –∫–Ω–æ–ø–∫–∞ –ø–µ—á–∞—Ç–∏ –≤ —à–∞–ø–∫–µ */
    .print-btn{
      cursor:pointer; border:1px solid rgba(96,165,250,.35);
      background:rgba(96,165,250,.15); color:var(--text);
      padding:8px 16px; border-radius:30px; font-size:13px;
      transition:background .1s;
    }
    .print-btn:hover{background:rgba(96,165,250,.25);}

    .grid{display:grid;grid-template-columns: 1.15fr 0.85fr;gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:rgba(18,26,51,.86);
      border:1px solid rgba(96,165,250,.16);
      border-radius:14px;
      padding:16px 16px 12px;
      box-shadow:0 10px 26px rgba(0,0,0,.25);
    }
    .card h2{font-size:14px;margin:0 0 10px;color:#cfe0ff;letter-spacing:.2px;}
    .row{display:grid;grid-template-columns:1.55fr 1fr;gap:10px;margin-bottom:8px;align-items:center;}
    label{font-size:12px;color:var(--muted);}
    input, select{
      width:100%; padding:10px 10px; border-radius:10px;
      border:1px solid rgba(154,167,199,.25); background:#0b1229; color:var(--text);
      outline:none; font-variant-numeric:tabular-nums;
    }
    input:focus, select:focus{border-color:rgba(96,165,250,.6);box-shadow:0 0 0 3px rgba(96,165,250,.14);}
    .small{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.35;}
    .hr{height:1px;background:linear-gradient(90deg,transparent,var(--line),transparent);margin:10px 0 12px;}

    table{width:100%;border-collapse:collapse;font-size:12px;}
    th, td{padding:9px 8px;border-bottom:1px solid rgba(36,48,85,.7);vertical-align:middle;}
    th{color:#cfe0ff;text-align:left;font-weight:600;}
    td.num{text-align:right;font-family:var(--mono);font-variant-numeric:tabular-nums;}

    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px;}
    @media (max-width: 720px){ .kpi{grid-template-columns:1fr 1fr;} }
    @media (max-width: 520px){ .kpi{grid-template-columns:1fr;} }
    .k{
      background:rgba(11,18,41,.7);
      border:1px solid rgba(154,167,199,.14);
      border-radius:12px;
      padding:10px;
    }
    .k .t{font-size:11px;color:var(--muted);}
    .k .v{margin-top:6px;font-family:var(--mono);font-size:15px;font-variant-numeric:tabular-nums;}

    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    button{
      cursor:pointer; border:1px solid rgba(96,165,250,.35);
      background:rgba(96,165,250,.15); color:var(--text);
      padding:10px 12px; border-radius:12px; font-size:12px;
    }
    button:hover{background:rgba(96,165,250,.22);}
    button.secondary{border-color:rgba(154,167,199,.25);background:rgba(154,167,199,.10);}

    /* ‚ÇΩ suffix inside input (wrap only RUB fields) */
    .input-wrap{position:relative;}
    .input-wrap input{padding-right:34px;}
    .input-wrap::after{
      content:"‚ÇΩ"; position:absolute; right:12px; top:50%; transform:translateY(-50%);
      color:var(--muted); font-size:12px; pointer-events:none;
    }

    .flags{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;}
    .pill{
      display:inline-flex;gap:6px;align-items:center;
      font-size:11px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(154,167,199,.25);color:var(--muted);
      background:rgba(11,18,41,.35);
    }
    .dot{width:8px;height:8px;border-radius:50%;}
    .dot.ok{background:var(--ok);}
    .dot.warn{background:var(--warn);}
    .dot.bad{background:var(--bad);}

    .margin-good{color:var(--ok);}
    .margin-mid{color:var(--warn);}
    .margin-bad{color:var(--bad);}

    .sens-wrap{margin-top:12px;}
    .sens-table{width:100%;border-collapse:collapse;font-size:12px;}
    .sens-table th, .sens-table td{border-bottom:1px solid rgba(36,48,85,.7);padding:7px 6px;}
    .sens-table th{color:#cfe0ff;text-align:center;font-weight:600;}
    .sens-table td{text-align:center;font-family:var(--mono);font-variant-numeric:tabular-nums;}

    .mini-note{margin-top:10px;color:var(--muted);font-size:11px;line-height:1.4;}

    /* Export mode: credit-committee PDF (—Å–∫—Ä—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏, –º–µ–Ω—è–µ—Ç —Ñ–æ–Ω) */
    body.export-mode{background:#ffffff !important;color:#0b1020 !important;}
    body.export-mode .card{background:#ffffff !important;border:1px solid #d4dbe8 !important;box-shadow:none !important;}
    body.export-mode .card h2, body.export-mode th{color:#0b1020 !important;}
    body.export-mode .sub, body.export-mode label, body.export-mode .small, body.export-mode .report-meta, body.export-mode .badge, body.export-mode .pill{color:#334155 !important;}
    body.export-mode input, body.export-mode select{background:#ffffff !important;color:#0b1020 !important;border:1px solid #d4dbe8 !important;box-shadow:none !important;}
    body.export-mode .input-wrap::after{color:#64748b !important;}
    body.export-mode td, body.export-mode th{border-bottom:1px solid #e6ebf5 !important;}
    body.export-mode .k{background:#f8fafc !important;border:1px solid #e6ebf5 !important;}
    body.export-mode button{display:none !important;}

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ export-mode, –Ω–æ —á–µ—Ä–µ–∑ @media print) */
    @media print {
      body{background:#ffffff !important;color:#0b1020 !important;}
      .card{background:#ffffff !important;border:1px solid #d4dbe8 !important;box-shadow:none !important;}
      .card h2, th{color:#0b1020 !important;}
      .sub, label, .small, .report-meta, .badge, .pill{color:#334155 !important;}
      input, select{background:#ffffff !important;color:#0b1020 !important;border:1px solid #d4dbe8 !important;box-shadow:none !important;}
      .input-wrap::after{color:#64748b !important;}
      td, th{border-bottom:1px solid #e6ebf5 !important;}
      .k{background:#f8fafc !important;border:1px solid #e6ebf5 !important;}
      button, .print-btn, .btns button, .btns{display:none !important;}
    }
  </style>
</head>

<body>
  <div class="wrap" id="reportRoot">
    <div class="report-header">
      <div>
        <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ú–ö–î (SPV + –≤–∑–∞–∏–º–æ–∑–∞–≤–∏—Å–∏–º—ã–π –ì–ü) ‚Äî CC v2.0</h1>
        <div class="sub">–°–ú–† ‚Üí CAPEX ‚Üí –ø—Ä–∏–±—ã–ª—å/–º–∞—Ä–∂–∞ + —Å—Ç—Ä–µ—Å—Å/—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å + –±–∞–Ω–∫–æ–≤—Å–∫–∏–π –±–ª–æ–∫ (DSCR/LTC/LTV) –∏ —ç–∫—Å–ø–æ—Ä—Ç PDF.</div>
      </div>
      <div style="display:flex; gap:12px; align-items:center;">
        <button class="print-btn" id="btnPrint">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å</button>
        <div class="report-meta">
          <div><span class="badge">–û—Ç—á–µ—Ç –¥–ª—è –∫—Ä–µ–¥–∏—Ç–Ω–æ–≥–æ –∫–æ–º–∏—Ç–µ—Ç–∞</span></div>
          <div>–î–∞—Ç–∞/–≤—Ä–µ–º—è: <span id="generatedAt">‚Äî</span></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: INPUTS -->
      <div class="card">
        <h2>1) –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
        <div class="row"><label for="gba">GBA (–º¬≤)</label><input id="gba" type="text" value="20000" inputmode="numeric" /></div>
        <div class="row"><label for="nsa">NSA (–º¬≤)</label><input id="nsa" type="text" value="14000" inputmode="numeric" /></div>
        <div class="row">
          <label for="price">–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ (‚ÇΩ/–º¬≤ NSA)</label>
          <div class="input-wrap"><input id="price" type="text" value="140000" inputmode="numeric" /></div>
        </div>

        <div class="hr"></div>
        <h2>2) –°–ú–† (—Ä—É–±/–º¬≤ GBA)</h2>
        <div class="row"><label for="c1">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤</label><div class="input-wrap"><input id="c1" type="text" value="22000" inputmode="numeric" /></div></div>
        <div class="row"><label for="c2">–§–∞—Å–∞–¥</label><div class="input-wrap"><input id="c2" type="text" value="7000" inputmode="numeric" /></div></div>
        <div class="row"><label for="c3">–ò–Ω–∂–µ–Ω–µ—Ä–∏—è</label><div class="input-wrap"><input id="c3" type="text" value="12000" inputmode="numeric" /></div></div>
        <div class="row"><label for="c4">–û—Ç–¥–µ–ª–∫–∞</label><div class="input-wrap"><input id="c4" type="text" value="8000" inputmode="numeric" /></div></div>
        <div class="row"><label for="c5">–ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</label><div class="input-wrap"><input id="c5" type="text" value="3500" inputmode="numeric" /></div></div>
        <div class="row"><label for="c6">–ü—Ä–æ—á–∏–µ</label><div class="input-wrap"><input id="c6" type="text" value="2500" inputmode="numeric" /></div></div>
        <div class="row"><label for="lift">–õ–∏—Ñ—Ç—ã (—Ñ–∏–∫—Å)</label><div class="input-wrap"><input id="lift" type="text" value="50000000" inputmode="numeric" /></div></div>

        <div class="hr"></div>
        <h2>3) –ù–∞–∫–ª–∞–¥–Ω—ã–µ / –ø—Ä–∏–±—ã–ª—å –ì–ü / —Ä–µ–∑–µ—Ä–≤</h2>
        <div class="row"><label for="overhead">–ù–∞–∫–ª–∞–¥–Ω—ã–µ, % –æ—Ç –ø—Ä—è–º—ã—Ö</label><input id="overhead" type="text" value="10" inputmode="decimal" /></div>
        <div class="row"><label for="gp">–ü—Ä–∏–±—ã–ª—å –ì–ü, % –æ—Ç (–ø—Ä—è–º—ã–µ+–Ω–∞–∫–ª–∞–¥–Ω—ã–µ)</label><input id="gp" type="text" value="5" inputmode="decimal" /></div>
        <div class="row"><label for="reserve">–†–µ–∑–µ—Ä–≤/—Ä–∏—Å–∫–∏, % –æ—Ç –°–ú–†</label><input id="reserve" type="text" value="2" inputmode="decimal" /></div>

        <div class="hr"></div>
        <h2>4) –ü—Ä–æ—á–∏–µ CAPEX (–Ω–µ –°–ú–†)</h2>
        <div class="row"><label for="land">–ó–µ–º–ª—è</label><div class="input-wrap"><input id="land" type="text" value="200000000" inputmode="numeric" /></div></div>
        <div class="row"><label for="tu">–¢–£ / —Å–µ—Ç–∏</label><div class="input-wrap"><input id="tu" type="text" value="120000000" inputmode="numeric" /></div></div>
        <div class="row"><label for="design">–ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</label><div class="input-wrap"><input id="design" type="text" value="35000000" inputmode="numeric" /></div></div>
        <div class="row"><label for="bank_fee">–ö–æ–º–∏—Å—Å–∏–∏ –±–∞–Ω–∫–∞ (—Ä–∞–∑–æ–≤–æ)</label><div class="input-wrap"><input id="bank_fee" type="text" value="20000000" inputmode="numeric" /></div></div>

        <div class="small">–ü—Ä–æ—Ü–µ–Ω—Ç—ã –ø–æ –∫—Ä–µ–¥–∏—Ç—É —Å—á–∏—Ç–∞—é—Ç—Å—è –Ω–∏–∂–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) –∏ –≤—Ö–æ–¥—è—Ç –≤ –∏—Ç–æ–≥–æ–≤—ã–π CAPEX/–¥–æ–ª–≥.</div>

        <div class="hr"></div>
        <h2>5) –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</h2>
        <div class="row"><label for="commercial">–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã, % –æ—Ç –≤—ã—Ä—É—á–∫–∏</label><input id="commercial" type="text" value="3" inputmode="decimal" /></div>

        <div class="hr"></div>
        <h2>6) –°—Ç—Ä–µ—Å—Å-–º–æ–¥–µ–ª—å</h2>
        <div class="row"><label for="stress_price">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã, %</label><input id="stress_price" type="text" value="-10" inputmode="decimal" /></div>
        <div class="row"><label for="stress_smr">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –°–ú–†, %</label><input id="stress_smr" type="text" value="15" inputmode="decimal" /></div>

        <div class="hr"></div>
        <h2>7) –ë–∞–Ω–∫ / –ø—Ä–æ–µ–∫—Ç–Ω–æ–µ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ / —ç—Å–∫—Ä–æ—É</h2>

        <div class="row"><label for="equity">–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ (Equity), ‚ÇΩ</label><div class="input-wrap"><input id="equity" type="text" value="300000000" inputmode="numeric" /></div></div>
        <div class="row"><label for="loan_limit">–õ–∏–º–∏—Ç –∫—Ä–µ–¥–∏—Ç–∞ (Debt limit), ‚ÇΩ</label><div class="input-wrap"><input id="loan_limit" type="text" value="2000000000" inputmode="numeric" /></div></div>

        <div class="row"><label for="rate">–°—Ç–∞–≤–∫–∞ –∫—Ä–µ–¥–∏—Ç–∞, % –≥–æ–¥–æ–≤—ã—Ö</label><input id="rate" type="text" value="18" inputmode="decimal" /></div>

        <div class="row"><label for="constr_months">–°—Ä–æ–∫ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞, –º–µ—Å</label><input id="constr_months" type="text" value="24" inputmode="numeric" /></div>
        <div class="row"><label for="tail_months">–°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞, –º–µ—Å</label><input id="tail_months" type="text" value="6" inputmode="numeric" /></div>

        <div class="row"><label for="pre_sale_share">–î–æ–ª—è –ø—Ä–æ–¥–∞–∂ –¥–æ –≤–≤–æ–¥–∞, % (—ç—Å–∫—Ä–æ—É)</label><input id="pre_sale_share" type="text" value="80" inputmode="decimal" /></div>
        <div class="row"><label for="escrow_release_months">–†–µ–ª–∏–∑ —ç—Å–∫—Ä–æ—É –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞, –º–µ—Å</label><input id="escrow_release_months" type="text" value="3" inputmode="numeric" /></div>

        <div class="row"><label for="capex_soft_months">‚Äú–ú—è–≥–∫–∏–µ‚Äù –∑–∞—Ç—Ä–∞—Ç—ã (–¢–£/–ø—Ä–æ–µ–∫—Ç), –º–µ—Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è</label><input id="capex_soft_months" type="text" value="6" inputmode="numeric" /></div>

        <div class="hr"></div>
        <h2>8) –ö–æ–≤–µ–Ω–∞–Ω—Ç—ã (–¥–ª—è —Ñ–ª–∞–≥–æ–≤)</h2>
        <div class="row"><label for="cov_dscr">Min DSCR (x)</label><input id="cov_dscr" type="text" value="1.20" inputmode="decimal" /></div>
        <div class="row"><label for="cov_ltc">Max LTC (%)</label><input id="cov_ltc" type="text" value="80" inputmode="decimal" /></div>
        <div class="row"><label for="cov_ltv">Max LTV (%)</label><input id="cov_ltv" type="text" value="70" inputmode="decimal" /></div>

        <div class="btns">
          <button id="btnPdf">–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF (A4) ‚Äî –∫—Ä–µ–¥–∏—Ç–Ω—ã–π –∫–æ–º–∏—Ç–µ—Ç</button>
          <button class="secondary" id="btnDemo">–î–µ–º–æ-–Ω–∞–±–æ—Ä</button>
          <button class="secondary" id="btnReset">–°–±—Ä–æ—Å</button>
        </div>

        <div class="mini-note">
          –ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –±–ª–æ–∫ ‚Äî —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π: CAPEX –°–ú–† —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –ø–æ —Å—Ä–æ–∫—É —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞, ‚Äú–º—è–≥–∫–∏–µ‚Äù –∑–∞—Ç—Ä–∞—Ç—ã ‚Äî —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –≤ –ø–µ—Ä–≤—ã–µ N –º–µ—Å—è—Ü–µ–≤, –∑–µ–º–ª—è/–∫–æ–º–∏—Å—Å–∏—è ‚Äî –≤ 1-–π –º–µ—Å—è—Ü. –ü—Ä–æ—Ü–µ–Ω—Ç—ã –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –≤ –¥–æ–ª–≥ –¥–æ –º–æ–º–µ–Ω—Ç–∞ —Ä–µ–ª–∏–∑–∞ —ç—Å–∫—Ä–æ—É, –∑–∞—Ç–µ–º –∏–∑ —Ä–µ–ª–∏–∑–∞ –ø–æ–≥–∞—à–∞–µ—Ç—Å—è –¥–æ–ª–≥.
        </div>
      </div>

      <!-- RIGHT: RESULTS -->
      <div class="card">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã (—ç–∫–æ–Ω–æ–º–∏–∫–∞)</h2>

        <table>
          <thead>
            <tr>
              <th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th>
              <th class="num">–ë–∞–∑–∞</th>
              <th class="num">–°—Ç—Ä–µ—Å—Å</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>–í—ã—Ä—É—á–∫–∞</td><td class="num" id="rev">‚Äî</td><td class="num" id="rev_s">‚Äî</td></tr>
            <tr><td>–ò—Ç–æ–≥–æ –°–ú–†</td><td class="num" id="smr">‚Äî</td><td class="num" id="smr_s">‚Äî</td></tr>
            <tr><td>–ò—Ç–æ–≥–æ CAPEX (–±–µ–∑ % –∫—Ä–µ–¥–∏—Ç–∞)</td><td class="num" id="capex_no_int">‚Äî</td><td class="num" id="capex_no_int_s">‚Äî</td></tr>
            <tr><td>–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</td><td class="num" id="comm">‚Äî</td><td class="num" id="comm_s">‚Äî</td></tr>
            <tr>
              <td><b>–ü—Ä–æ—Ñ–∏—Ç –¥–µ–≤–µ–ª–æ–ø–µ—Ä–∞ (–ø–æ—Å–ª–µ % –∫—Ä–µ–¥–∏—Ç–∞)</b></td>
              <td class="num" id="profit"><b>‚Äî</b></td>
              <td class="num" id="profit_s"><b>‚Äî</b></td>
            </tr>
          </tbody>
        </table>

        <div class="kpi">
          <div class="k"><div class="t">–°–ú–† ‚ÇΩ/–º¬≤ GBA</div><div class="v" id="smr_m2">‚Äî</div></div>
          <div class="k"><div class="t">CAPEX ‚ÇΩ/–º¬≤ NSA</div><div class="v" id="capex_m2">‚Äî</div></div>
          <div class="k"><div class="t">–ú–∞—Ä–∂–∞ –¥–µ–≤–µ–ª–æ–ø–µ—Ä–∞</div><div class="v" id="margin_pct">‚Äî</div></div>
          <div class="k"><div class="t">–ó–∞–ø–∞—Å –∫ —Ü–µ–Ω–µ (‚ÇΩ/–º¬≤ NSA)</div><div class="v" id="buffer">‚Äî</div></div>
        </div>

        <div class="flags" id="flagsEco"></div>

        <div class="hr"></div>
        <h2>–ë–∞–Ω–∫-KPI (DSCR / LTC / LTV)</h2>

        <table>
          <tbody>
            <tr><th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th><th class="num">–ë–∞–∑–∞</th><th class="num">–°—Ç—Ä–µ—Å—Å</th></tr>
            <tr><td>Max Debt (–ø–∏–∫ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏)</td><td class="num" id="b_maxdebt">‚Äî</td><td class="num" id="b_maxdebt_s">‚Äî</td></tr>
            <tr><td>–ü—Ä–æ—Ü–µ–Ω—Ç—ã –ø–æ –∫—Ä–µ–¥–∏—Ç—É (–∫–∞–ø–∏—Ç–∞–ª–∏–∑.)</td><td class="num" id="b_int">‚Äî</td><td class="num" id="b_int_s">‚Äî</td></tr>
            <tr><td>LTC = Max Debt / Total Cost</td><td class="num" id="b_ltc">‚Äî</td><td class="num" id="b_ltc_s">‚Äî</td></tr>
            <tr><td>LTV = Max Debt / Revenue</td><td class="num" id="b_ltv">‚Äî</td><td class="num" id="b_ltv_s">‚Äî</td></tr>
            <tr><td>Min DSCR (–ø–æ –º–µ—Å—è—Ü–∞–º —Ä–µ–ª–∏–∑–∞)</td><td class="num" id="b_dscr_min">‚Äî</td><td class="num" id="b_dscr_min_s">‚Äî</td></tr>
            <tr><td>Avg DSCR (–ø–æ –º–µ—Å—è—Ü–∞–º —Ä–µ–ª–∏–∑–∞)</td><td class="num" id="b_dscr_avg">‚Äî</td><td class="num" id="b_dscr_avg_s">‚Äî</td></tr>
          </tbody>
        </table>

        <div class="flags" id="flagsBank"></div>

        <div class="hr"></div>
        <h2>–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 5√ó5 (–º–∞—Ä–∂–∞ –¥–µ–≤–µ–ª–æ–ø–µ—Ä–∞, %)</h2>
        <div class="small">–°—Ç—Ä–æ–∫–∏: –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã. –°—Ç–æ–ª–±—Ü—ã: –∏–∑–º–µ–Ω–µ–Ω–∏–µ –°–ú–†. –¶–≤–µ—Ç ‚Äî —É—Ä–æ–≤–µ–Ω—å —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏.</div>
        <div class="sens-wrap" id="sensitivity">‚Äî</div>
      </div>
    </div>
  </div>

  <script>
    // ---------- utils ----------
    const $ = (id) => document.getElementById(id);

    function parseNumber(v){
      const s = String(v ?? "")
        .replace(/[‚ÇΩ\u00A0\s]/g, "")
        .replace(",", ".");
      const x = Number(s);
      return Number.isFinite(x) ? x : 0;
    }
    function fmtInt(x){ return Math.round(x).toLocaleString("ru-RU"); }
    function rub(x){ return fmtInt(x) + " ‚ÇΩ"; }
    function rubm2(x){ return fmtInt(x) + " ‚ÇΩ/–º¬≤"; }
    function percent(x){
      return (x*100).toLocaleString("ru-RU",{minimumFractionDigits:1, maximumFractionDigits:1}) + " %";
    }
    function xNum(x){
      return (x).toLocaleString("ru-RU",{minimumFractionDigits:2, maximumFractionDigits:2}) + "x";
    }
    function get(id){ return parseNumber($(id).value); }

    function setGeneratedAt(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      $("generatedAt").textContent =
        `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function marginClass(m){
      if (m >= 0.18) return "margin-good";
      if (m >= 0.10) return "margin-mid";
      return "margin-bad";
    }
    function pill(type, text){
      const div = document.createElement("div");
      div.className = "pill";
      const dot = document.createElement("span");
      dot.className = "dot " + type;
      const t = document.createElement("span");
      t.textContent = text;
      div.appendChild(dot); div.appendChild(t);
      return div;
    }

    // ---------- core economics (without bank interest) ----------
    function econScenario(priceMul, smrMul){
      const gba = get("gba");
      const nsa = get("nsa");
      const price = get("price") * priceMul;

      const directPerM2 = get("c1")+get("c2")+get("c3")+get("c4")+get("c5")+get("c6");
      const direct = (gba * directPerM2 + get("lift")) * smrMul;

      const overhead = direct * (get("overhead")/100);
      const gpProfit = (direct + overhead) * (get("gp")/100);
      const reserve = (direct + overhead + gpProfit) * (get("reserve")/100);

      const smr = direct + overhead + gpProfit + reserve;

      const capexNoInt = smr + get("land") + get("tu") + get("design") + get("bank_fee");

      const revenue = nsa * price;
      const commercial = revenue * (get("commercial")/100);

      return { gba, nsa, price, revenue, direct, overhead, gpProfit, reserve, smr, capexNoInt, commercial };
    }

    // ---------- bank / escrow monthly simulation ----------
    function bankScenario(priceMul, smrMul){
      const econ = econScenario(priceMul, smrMul);

      const constr = Math.max(1, Math.round(get("constr_months")));
      const tail = Math.max(0, Math.round(get("tail_months")));
      const rel = Math.max(1, Math.round(get("escrow_release_months")));
      const softM = Math.max(1, Math.round(get("capex_soft_months")));

      const equity = get("equity");
      const loanLimit = get("loan_limit");
      const rate = get("rate")/100;
      const rMonthly = rate / 12;

      const preShare = Math.min(100, Math.max(0, get("pre_sale_share"))) / 100;

      const totalRevenue = econ.revenue;
      const preRevenue = totalRevenue * preShare;
      const tailRevenue = totalRevenue - preRevenue;

      // sales schedule
      const preSalesMonthly = preRevenue / constr;
      const tailSalesMonthly = tail > 0 ? (tailRevenue / tail) : 0;

      // escrow accumulation during construction
      let escrowBal = 0;

      // capex schedule
      const smrMonthly = econ.smr / constr;
      const landPay = get("land");
      const bankFeePay = get("bank_fee");
      const tuPay = get("tu");
      const designPay = get("design");
      const softMonthly = (tuPay + designPay) / softM;

      // commercial schedule tied to sales (we assume paid when sales booked)
      const commPct = get("commercial")/100;

      // timeline length
      const totalMonths = constr + tail + rel;

      let cash = equity;
      let debt = 0;
      let maxDebt = 0;
      let capIntTotal = 0;

      let dscrMin = Infinity;
      let dscrSum = 0;
      let dscrCnt = 0;

      for (let m=1; m<=totalMonths; m++){
        const inConstruction = m <= constr;
        const inTail = (m > constr) && (m <= constr + tail);
        const inRelease = (m > constr) && (m <= constr + rel);

        // SALES
        let sales = 0;
        if (inConstruction){
          sales = preSalesMonthly;
          escrowBal += sales; // goes to escrow
        } else if (inTail){
          sales = tailSalesMonthly; // assume cash available (simplification)
        }

        // COMMERCIAL outflow as % of sales booked this month
        const commOut = sales * commPct;

        // CAPEX outflow this month
        let capexOut = 0;
        if (inConstruction){
          capexOut += smrMonthly;
        }
        // land & bank fee month 1
        if (m === 1){
          capexOut += landPay + bankFeePay;
        }
        // soft costs evenly in first softM months
        if (m <= softM){
          capexOut += softMonthly;
        }

        // CASH INFLOW from escrow release
        let escrowRelease = 0;
        if (inRelease){
          escrowRelease = preRevenue / rel;
        }

        // CASH inflow from tail sales assumed immediately available
        const tailCashIn = (!inConstruction && inTail) ? sales : 0;

        // Interest accrual
        const interestAccrued = debt * rMonthly;

        let interestPaid = 0;
        let principalPaid = 0;

        cash += escrowRelease + tailCashIn;
        cash -= (capexOut + commOut);

        if (inConstruction){
          // Capitalize interest
          debt += interestAccrued;
          capIntTotal += interestAccrued;
        } else {
          // Pay interest if possible, otherwise capitalize remainder
          if (cash >= interestAccrued){
            cash -= interestAccrued;
            interestPaid = interestAccrued;
          } else {
            interestPaid = Math.max(0, cash);
            const short = interestAccrued - interestPaid;
            cash = 0;
            debt += short;
            capIntTotal += short;
          }
        }

        // If cash negative -> draw debt
        if (cash < 0){
          const need = -cash;
          const draw = Math.min(need, Math.max(0, loanLimit - debt));
          debt += draw;
          cash += draw;
          if (cash < 0) cash = 0;
        }

        // During release: repay principal from remaining cash
        if (inRelease){
          if (cash > 0 && debt > 0){
            principalPaid = Math.min(cash, debt);
            debt -= principalPaid;
            cash -= principalPaid;
          }

          const cfads = escrowRelease + tailCashIn - capexOut - commOut;
          const debtService = interestPaid + principalPaid;

          if (debtService > 0){
            const dscr = cfads / debtService;
            dscrMin = Math.min(dscrMin, dscr);
            dscrSum += dscr;
            dscrCnt += 1;
          }
        }

        maxDebt = Math.max(maxDebt, debt);
      }

      if (dscrMin === Infinity) dscrMin = 0;
      const dscrAvg = dscrCnt > 0 ? (dscrSum / dscrCnt) : 0;

      const totalCost = econ.capexNoInt + econ.commercial + capIntTotal;
      const ltc = totalCost > 0 ? (maxDebt / totalCost) : 0;
      const ltv = econ.revenue > 0 ? (maxDebt / econ.revenue) : 0;

      const devProfit = econ.revenue - (econ.capexNoInt + econ.commercial + capIntTotal);
      const devMargin = econ.revenue !== 0 ? devProfit / econ.revenue : 0;

      return {
        econ,
        capIntTotal,
        maxDebt,
        ltc,
        ltv,
        dscrMin,
        dscrAvg,
        devProfit,
        devMargin
      };
    }

    // ---------- sensitivity 5x5 ----------
    function renderSensitivity(){
      const smrRange = [-0.10,-0.05,0,0.05,0.10];
      const priceRange = [-0.10,-0.05,0,0.05,0.10];

      let html = `<table class="sens-table"><thead><tr><th>–¶–µ–Ω–∞ \\ –°–ú–†</th>`;
      for (const s of smrRange) html += `<th>${(s*100).toLocaleString("ru-RU")}%</th>`;
      html += `</tr></thead><tbody>`;

      for (const p of priceRange){
        html += `<tr><th>${(p*100).toLocaleString("ru-RU")}%</th>`;
        for (const s of smrRange){
          const b = bankScenario(1+p, 1+s);
          const cls = marginClass(b.devMargin);
          html += `<td class="${cls}">${percent(b.devMargin)}</td>`;
        }
        html += `</tr>`;
      }
      html += `</tbody></table>`;
      $("sensitivity").innerHTML = html;
    }

    // ---------- flags ----------
    function renderEcoFlags(baseBank, stressBank){
      const el = $("flagsEco");
      el.innerHTML = "";

      const m = baseBank.devMargin;
      el.appendChild(pill(baseBank.devProfit >= 0 ? "ok":"bad", baseBank.devProfit >= 0 ? "–ë–∞–∑–∞: –ø—Ä–∏–±—ã–ª—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è" : "–ë–∞–∑–∞: –ø—Ä–∏–±—ã–ª—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è"));
      if (m >= 0.18) el.appendChild(pill("ok", `–ú–∞—Ä–∂–∞ –±–∞–∑—ã ${percent(m)} ‚Äî –≤—ã—Å–æ–∫–∏–π –∑–∞–ø–∞—Å`));
      else if (m >= 0.10) el.appendChild(pill("warn", `–ú–∞—Ä–∂–∞ –±–∞–∑—ã ${percent(m)} ‚Äî —Å—Ä–µ–¥–Ω–∏–π –∑–∞–ø–∞—Å`));
      else el.appendChild(pill("bad", `–ú–∞—Ä–∂–∞ –±–∞–∑—ã ${percent(m)} ‚Äî –Ω–∏–∑–∫–∏–π –∑–∞–ø–∞—Å`));

      const ms = stressBank.devMargin;
      el.appendChild(pill(stressBank.devProfit >= 0 ? "ok":"bad", stressBank.devProfit >= 0 ? "–°—Ç—Ä–µ—Å—Å: –ø—Ä–∏–±—ã–ª—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è" : "–°—Ç—Ä–µ—Å—Å: –ø—Ä–∏–±—ã–ª—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è"));
      if (ms < 0.10) el.appendChild(pill("bad", `–°—Ç—Ä–µ—Å—Å-–º–∞—Ä–∂–∞ ${percent(ms)} ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ`));

      const gba = get("gba"), nsa = get("nsa");
      if (gba <= 0 || nsa <= 0) el.appendChild(pill("bad", "–ü–ª–æ—â–∞–¥–∏: GBA/NSA –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å > 0"));
      if (nsa > gba) el.appendChild(pill("warn", "NSA > GBA ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–æ–¥"));
    }

    function renderBankFlags(baseBank, stressBank){
      const el = $("flagsBank");
      el.innerHTML = "";

      const covD = get("cov_dscr");
      const covLTC = get("cov_ltc")/100;
      const covLTV = get("cov_ltv")/100;

      el.appendChild(pill(
        baseBank.dscrMin >= covD ? "ok" : "bad",
        `DSCR min (–±–∞–∑–∞): ${xNum(baseBank.dscrMin)} vs cov ${xNum(covD)}`
      ));
      el.appendChild(pill(
        baseBank.ltc <= covLTC ? "ok" : "bad",
        `LTC (–±–∞–∑–∞): ${percent(baseBank.ltc)} vs cov ${percent(covLTC)}`
      ));
      el.appendChild(pill(
        baseBank.ltv <= covLTV ? "ok" : "bad",
        `LTV (–±–∞–∑–∞): ${percent(baseBank.ltv)} vs cov ${percent(covLTV)}`
      ));

      el.appendChild(pill(
        stressBank.dscrMin >= covD ? "ok" : "bad",
        `DSCR min (—Å—Ç—Ä–µ—Å—Å): ${xNum(stressBank.dscrMin)}`
      ));
      el.appendChild(pill(
        stressBank.ltc <= covLTC ? "ok" : "bad",
        `LTC (—Å—Ç—Ä–µ—Å—Å): ${percent(stressBank.ltc)}`
      ));
      el.appendChild(pill(
        stressBank.ltv <= covLTV ? "ok" : "bad",
        `LTV (—Å—Ç—Ä–µ—Å—Å): ${percent(stressBank.ltv)}`
      ));

      const loanLimit = get("loan_limit");
      if (baseBank.maxDebt > loanLimit) el.appendChild(pill("bad", "–ü–∏–∫ –¥–æ–ª–≥–∞ (–±–∞–∑–∞) –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –∫—Ä–µ–¥–∏—Ç–∞"));
      else el.appendChild(pill("ok", "–ü–∏–∫ –¥–æ–ª–≥–∞ (–±–∞–∑–∞) –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞"));

      if (stressBank.maxDebt > loanLimit) el.appendChild(pill("bad", "–ü–∏–∫ –¥–æ–ª–≥–∞ (—Å—Ç—Ä–µ—Å—Å) –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –∫—Ä–µ–¥–∏—Ç–∞"));
      else el.appendChild(pill("ok", "–ü–∏–∫ –¥–æ–ª–≥–∞ (—Å—Ç—Ä–µ—Å—Å) –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞"));
    }

    // ---------- render all ----------
    function calcAndRender(){
      setGeneratedAt();

      const base = bankScenario(1,1);
      const stress = bankScenario(1 + get("stress_price")/100, 1 + get("stress_smr")/100);

      $("rev").textContent = rub(base.econ.revenue);
      $("rev_s").textContent = rub(stress.econ.revenue);
      $("smr").textContent = rub(base.econ.smr);
      $("smr_s").textContent = rub(stress.econ.smr);
      $("capex_no_int").textContent = rub(base.econ.capexNoInt);
      $("capex_no_int_s").textContent = rub(stress.econ.capexNoInt);
      $("comm").textContent = rub(base.econ.commercial);
      $("comm_s").textContent = rub(stress.econ.commercial);
      $("profit").textContent = rub(base.devProfit);
      $("profit_s").textContent = rub(stress.devProfit);
      $("profit").className = "num " + marginClass(base.devMargin);
      $("profit_s").className = "num " + marginClass(stress.devMargin);

      $("smr_m2").textContent = base.econ.gba ? rubm2(base.econ.smr / base.econ.gba) : "‚Äî";
      const totalCostBase = base.econ.capexNoInt + base.econ.commercial + base.capIntTotal;
      $("capex_m2").textContent = base.econ.nsa ? rubm2(totalCostBase / base.econ.nsa) : "‚Äî";
      $("margin_pct").textContent = percent(base.devMargin);
      $("margin_pct").className = "v " + marginClass(base.devMargin);
      $("buffer").textContent = base.econ.nsa ? rubm2(base.econ.price - (totalCostBase / base.econ.nsa)) : "‚Äî";

      $("b_maxdebt").textContent = rub(base.maxDebt);
      $("b_maxdebt_s").textContent = rub(stress.maxDebt);
      $("b_int").textContent = rub(base.capIntTotal);
      $("b_int_s").textContent = rub(stress.capIntTotal);
      $("b_ltc").textContent = percent(base.ltc);
      $("b_ltc_s").textContent = percent(stress.ltc);
      $("b_ltv").textContent = percent(base.ltv);
      $("b_ltv_s").textContent = percent(stress.ltv);
      $("b_dscr_min").textContent = xNum(base.dscrMin);
      $("b_dscr_min_s").textContent = xNum(stress.dscrMin);
      $("b_dscr_avg").textContent = xNum(base.dscrAvg);
      $("b_dscr_avg_s").textContent = xNum(stress.dscrAvg);

      renderEcoFlags(base, stress);
      renderBankFlags(base, stress);
      renderSensitivity();
    }

    // ---------- localStorage ----------
    const STORAGE_KEY = "mkdCalculatorData";

    function saveState(){
      const ids = [
        "gba","nsa","price",
        "c1","c2","c3","c4","c5","c6","lift",
        "overhead","gp","reserve",
        "land","tu","design","bank_fee",
        "commercial","stress_price","stress_smr",
        "equity","loan_limit","rate",
        "constr_months","tail_months","pre_sale_share","escrow_release_months","capex_soft_months",
        "cov_dscr","cov_ltc","cov_ltv"
      ];
      const data = {};
      ids.forEach(id => { data[id] = $(id).value; });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try {
        const data = JSON.parse(raw);
        Object.keys(data).forEach(id => {
          const el = $(id);
          if (el) el.value = data[id];
        });
        return true;
      } catch (e) {
        console.warn("Failed to load from localStorage", e);
        return false;
      }
    }

    // ---------- input masking + auto-save ----------
    const PERCENT_IDS = new Set([
      "overhead","gp","reserve","commercial","stress_price","stress_smr",
      "rate","pre_sale_share","cov_ltc","cov_ltv"
    ]);
    const DECIMAL_IDS = new Set(["cov_dscr"]);

    function attachInputMask(id){
      const el = $(id);

      el.addEventListener("focus", () => {
        el.value = String(parseNumber(el.value));
      });

      el.addEventListener("blur", () => {
        const v = parseNumber(el.value);
        if (PERCENT_IDS.has(id) || DECIMAL_IDS.has(id)){
          el.value = v.toLocaleString("ru-RU",{maximumFractionDigits:2});
        } else {
          el.value = fmtInt(v);
        }
        calcAndRender();
        saveState(); // –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      });

      el.addEventListener("input", () => calcAndRender());

      // –Ω–∞—á–∞–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ storage, —Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
      const init = parseNumber(el.value);
      if (PERCENT_IDS.has(id) || DECIMAL_IDS.has(id)){
        el.value = init.toLocaleString("ru-RU",{maximumFractionDigits:2});
      } else {
        el.value = fmtInt(init);
      }
    }

    // ---------- PDF export (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫) ----------
    async function exportPdf(){
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
      if (typeof html2canvas === "undefined" || typeof window.jspdf === "undefined"){
        alert("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è PDF –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
        return;
      }
      document.body.classList.add("export-mode");
      await new Promise(r => setTimeout(r, 120));

      const root = document.getElementById("reportRoot");
      try {
        const canvas = await html2canvas(root, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
        const imgData = canvas.toDataURL("image/png");

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });

        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        const imgWidth = pageWidth;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        let y = 0;
        let remaining = imgHeight;

        if (imgHeight <= pageHeight){
          pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
        } else {
          while (remaining > 0){
            pdf.addImage(imgData, "PNG", 0, -y, imgWidth, imgHeight);
            remaining -= pageHeight;
            y += pageHeight;
            if (remaining > 0) pdf.addPage();
          }
        }

        const now = new Date();
        const pad = (n)=>String(n).padStart(2,"0");
        const fname = `MKD_CC_${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.pdf`;
        pdf.save(fname);
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF:", error);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å PDF. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏.");
      } finally {
        document.body.classList.remove("export-mode");
      }
    }

    // ---------- init ----------
    function init(){
      // —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      loadState();

      const ids = [
        "gba","nsa","price",
        "c1","c2","c3","c4","c5","c6","lift",
        "overhead","gp","reserve",
        "land","tu","design","bank_fee",
        "commercial","stress_price","stress_smr",
        "equity","loan_limit","rate",
        "constr_months","tail_months","pre_sale_share","escrow_release_months","capex_soft_months",
        "cov_dscr","cov_ltc","cov_ltv"
      ];
      ids.forEach(attachInputMask);

      // –∫–Ω–æ–ø–∫–∏
      $("btnPdf").addEventListener("click", exportPdf);
      $("btnPrint").addEventListener("click", () => window.print());
      $("btnReset").addEventListener("click", () => {
        localStorage.removeItem(STORAGE_KEY);
        window.location.reload();
      });

      $("btnDemo").addEventListener("click", () => {
        $("gba").value = "24 000";
        $("nsa").value = "16 800";
        $("price").value = "145 000";

        $("c1").value = "22 500";
        $("c2").value = "7 000";
        $("c3").value = "12 500";
        $("c4").value = "8 500";
        $("c5").value = "3 800";
        $("c6").value = "2 600";
        $("lift").value = "52 000 000";

        $("overhead").value = "10";
        $("gp").value = "5";
        $("reserve").value = "2";

        $("land").value = "220 000 000";
        $("tu").value = "140 000 000";
        $("design").value = "40 000 000";
        $("bank_fee").value = "25 000 000";

        $("commercial").value = "3";
        $("stress_price").value = "-10";
        $("stress_smr").value = "15";

        $("equity").value = "350 000 000";
        $("loan_limit").value = "2 100 000 000";
        $("rate").value = "18";

        $("constr_months").value = "24";
        $("tail_months").value = "6";
        $("pre_sale_share").value = "80";
        $("escrow_release_months").value = "3";
        $("capex_soft_months").value = "6";

        $("cov_dscr").value = "1.20";
        $("cov_ltc").value = "80";
        $("cov_ltv").value = "70";

        // –ø–µ—Ä–µ–ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∞—Å–∫–∏ (–ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, –ø—Ä–æ—Å—Ç–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º)
        ids.forEach(id => {
          const el = $(id);
          const v = parseNumber(el.value);
          if (PERCENT_IDS.has(id) || DECIMAL_IDS.has(id)){
            el.value = v.toLocaleString("ru-RU",{maximumFractionDigits:2});
          } else {
            el.value = fmtInt(v);
          }
        });
        calcAndRender();
        saveState();
      });

      calcAndRender();
      // —Å–æ—Ö—Ä–∞–Ω–∏–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –±—ã–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ)
      saveState();
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
```
